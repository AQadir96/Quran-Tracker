<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#d4a843"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<link rel="apple-touch-icon" href="icon-192.png"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Quran Tracker ‚Äî Daily Progress</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #1c2333;
    --surface3: #21262d;
    --border: #30363d;
    --gold: #d4a843;
    --gold2: #f0c060;
    --green: #3fb950;
    --text: #e6edf3;
    --muted: #8b949e;
    --accent: #388bfd;
    --radius: 12px;
    --shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }
  /* Subtle star bg */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background: radial-gradient(ellipse at 20% 10%, rgba(212,168,67,0.07) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 80%, rgba(56,139,253,0.05) 0%, transparent 60%);
    pointer-events: none; z-index: 0;
  }
  /* ---- HEADER ---- */
  header {
    position: relative; z-index: 10;
    padding: 20px 32px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--border);
    background: rgba(13,17,23,0.9);
    backdrop-filter: blur(12px);
  }
  .logo { display: flex; align-items: center; gap: 12px; }
  .logo-icon {
    width: 38px; height: 38px;
    background: linear-gradient(135deg, var(--gold), var(--gold2));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
  }
  .logo-text { font-size: 18px; font-weight: 600; letter-spacing: -.3px; }
  .logo-sub { font-size: 11px; color: var(--muted); letter-spacing: .5px; text-transform: uppercase; }
  .header-actions { display: flex; gap: 10px; align-items: center; }
  /* ---- TABS ---- */
  .tabs {
    position: relative; z-index: 5;
    display: flex; gap: 0;
    padding: 0 32px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }
  .tab {
    padding: 14px 20px;
    font-size: 13px; font-weight: 500;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all .2s;
    white-space: nowrap;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--gold); border-bottom-color: var(--gold); }
  /* ---- MAIN ---- */
  main {
    position: relative; z-index: 1;
    max-width: 1100px; margin: 0 auto;
    padding: 32px 24px;
  }
  .page { display: none; }
  .page.active { display: block; }
  /* ---- CARDS ---- */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
  }
  .card-title {
    font-size: 12px; font-weight: 600; letter-spacing: 1px;
    text-transform: uppercase; color: var(--muted);
    margin-bottom: 16px;
  }
  /* ---- BUTTONS ---- */
  .btn {
    padding: 9px 18px;
    border-radius: 8px;
    font-size: 13px; font-weight: 500;
    cursor: pointer; border: none;
    transition: all .15s;
    font-family: inherit;
  }
  .btn-gold {
    background: linear-gradient(135deg, var(--gold), var(--gold2));
    color: #0d1117;
  }
  .btn-gold:hover { opacity: .9; transform: translateY(-1px); }
  .btn-outline {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
  }
  .btn-outline:hover { border-color: var(--gold); color: var(--gold); }
  .btn-ghost {
    background: transparent;
    color: var(--muted);
  }
  .btn-ghost:hover { color: var(--text); }
  /* ---- FORM ---- */
  .form-group { margin-bottom: 16px; }
  label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; font-weight: 500; }
  select, input {
    width: 100%;
    background: var(--surface3);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    padding: 10px 12px;
    font-size: 14px;
    font-family: inherit;
    outline: none;
    transition: border-color .2s;
    appearance: none;
    -webkit-appearance: none;
  }
  select:focus, input:focus { border-color: var(--gold); }
  select option { background: var(--surface3); }
  /* ---- GRID ---- */
  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  @media(max-width:700px) {
    .grid2, .grid3 { grid-template-columns: 1fr; }
    header { padding: 14px 16px; }
    main { padding: 20px 14px; }
    .tabs { padding: 0 12px; overflow-x: auto; }
  }
  /* ---- STAT CARD ---- */
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    position: relative; overflow: hidden;
  }
  .stat-card::after {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 3px;
  }
  .stat-card.gold::after { background: linear-gradient(90deg, var(--gold), var(--gold2)); }
  .stat-card.green::after { background: var(--green); }
  .stat-card.blue::after { background: var(--accent); }
  .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .8px; }
  .stat-val { font-size: 28px; font-weight: 700; margin: 6px 0 2px; color: var(--gold2); }
  .stat-sub { font-size: 12px; color: var(--muted); }
  /* ---- PROGRESS BAR ---- */
  .progress-wrap { margin: 8px 0; }
  .progress-label { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
  .progress-bar { height: 6px; background: var(--surface3); border-radius: 99px; overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 99px; background: linear-gradient(90deg, var(--gold), var(--gold2)); transition: width .6s ease; }
  /* ---- LEADERBOARD ---- */
  .lb-row {
    display: flex; align-items: center; gap: 14px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .lb-row:last-child { border-bottom: none; }
  .lb-rank { font-size: 14px; font-weight: 700; width: 24px; text-align: center; }
  .lb-rank.gold { color: #ffd700; }
  .lb-rank.silver { color: #c0c0c0; }
  .lb-rank.bronze { color: #cd7f32; }
  .lb-avatar {
    width: 36px; height: 36px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 700;
    flex-shrink: 0;
  }
  .lb-info { flex: 1; }
  .lb-name { font-size: 14px; font-weight: 600; }
  .lb-detail { font-size: 11px; color: var(--muted); }
  .lb-pages { font-size: 18px; font-weight: 700; color: var(--gold2); }
  /* ---- LOG LIST ---- */
  .log-item {
    display: flex; align-items: flex-start; gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .log-item:last-child { border-bottom: none; }
  .log-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--gold);
    margin-top: 5px; flex-shrink: 0;
  }
  .log-text { font-size: 13px; line-height: 1.6; }
  .log-meta { font-size: 11px; color: var(--muted); margin-top: 2px; }
  /* ---- ARABIC ---- */
  .arabic { font-family: 'Amiri', serif; direction: rtl; }
  /* ---- BADGE ---- */
  .badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 8px;
    border-radius: 99px;
    font-size: 11px; font-weight: 600;
    background: rgba(212,168,67,0.15);
    color: var(--gold2);
    border: 1px solid rgba(212,168,67,0.3);
  }
  .badge.green { background: rgba(63,185,80,0.1); color: var(--green); border-color: rgba(63,185,80,0.3); }
  /* ---- USER SELECTOR ---- */
  .user-pill {
    display: flex; align-items: center; gap: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 99px;
    padding: 6px 14px 6px 8px;
    cursor: pointer;
    font-size: 13px; font-weight: 500;
    transition: border-color .2s;
  }
  .user-pill:hover { border-color: var(--gold); }
  .user-pill .avatar {
    width: 24px; height: 24px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700;
  }
  /* ---- MODAL ---- */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 100;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    width: 100%; max-width: 480px;
    margin: 16px;
    animation: slideUp .25s ease;
  }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
  /* ---- NOTIFY ---- */
  .notify {
    position: fixed; top: 20px; right: 20px; z-index: 999;
    background: var(--surface);
    border: 1px solid var(--green);
    color: var(--green);
    padding: 12px 18px;
    border-radius: 10px;
    font-size: 13px; font-weight: 500;
    display: none;
    animation: fadeIn .3s ease;
    box-shadow: var(--shadow);
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
  /* ---- JUZZ GRID ---- */
  .juz-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
  .juz-cell {
    background: var(--surface3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 6px;
    text-align: center;
    cursor: pointer;
    transition: all .2s;
    font-size: 13px;
  }
  .juz-cell:hover { border-color: var(--gold); background: rgba(212,168,67,0.08); }
  .juz-cell.read { background: rgba(212,168,67,0.15); border-color: rgba(212,168,67,0.5); color: var(--gold2); }
  .juz-cell .juz-num { font-size: 18px; font-weight: 700; }
  .juz-cell .juz-label { font-size: 10px; color: var(--muted); margin-top: 2px; }
  /* ---- SUB SEGMENTS ---- */
  .seg-row {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px;
    background: var(--surface3);
    border-radius: 8px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: background .2s;
  }
  .seg-row:hover { background: var(--surface2); }
  .seg-row input[type=checkbox] { accent-color: var(--gold); width: 16px; height: 16px; cursor: pointer; flex-shrink:0; }
  .seg-info { flex: 1; }
  .seg-name { font-size: 13px; font-weight: 500; }
  .seg-sub { font-size: 11px; color: var(--muted); }
  /* ---- CHART ---- */
  .chart-wrap { position: relative; height: 240px; }
  /* ---- EMPTY STATE ---- */
  .empty { text-align: center; padding: 40px 20px; color: var(--muted); }
  .empty-icon { font-size: 40px; margin-bottom: 12px; }
  .empty-text { font-size: 14px; }
  /* ---- SECTION TITLE ---- */
  .section-title {
    font-size: 20px; font-weight: 700;
    margin-bottom: 20px;
    display: flex; align-items: center; gap: 10px;
  }
  .section-title span { color: var(--gold); }
  /* ---- NAMES INPUT ---- */
  .name-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
  .chip {
    display: flex; align-items: center; gap: 6px;
    background: var(--surface3);
    border: 1px solid var(--border);
    border-radius: 99px;
    padding: 5px 10px 5px 8px;
    font-size: 12px;
  }
  .chip .chip-del { cursor: pointer; color: var(--muted); font-size: 14px; line-height: 1; }
  .chip .chip-del:hover { color: #f85149; }
  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }
</style>
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import{getFirestore,collection,addDoc,onSnapshot,query,orderBy,deleteDoc,where,getDocs,doc}
  from"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
const cfg={
  apiKey:"AIzaSyDIa2Klm7lRI7xDlion2YNeYr5n2PB4byc",
  authDomain:"quran-tracker-2026.firebaseapp.com",
  projectId:"quran-tracker-2026",
  storageBucket:"quran-tracker-2026.firebasestorage.app",
  messagingSenderId:"978262243606",
  appId:"1:978262243606:web:144665037dc77dc291b837"
};
const app=initializeApp(cfg);
const db=getFirestore(app);
window._fb={db,collection,addDoc,onSnapshot,query,orderBy,deleteDoc,where,getDocs,doc};
window._fbOK=true;
</script>
</head>
<body>

<!-- Notification -->
<div class="notify" id="notify"></div>

<!-- User Select Modal -->
<div class="modal-overlay" id="userModal">
  <div class="modal">
    <div class="modal-title">üë§ Who are you?</div>
    <div id="userList" style="margin-bottom:16px;"></div>
    <div style="display:flex;gap:10px;">
      <input id="newUserInput" placeholder="Add new person‚Ä¶" style="flex:1;" />
      <button class="btn btn-gold" onclick="addUser()">Add</button>
    </div>
    <div class="name-chips" id="userChips"></div>
  </div>
</div>

<!-- Log Reading Modal -->
<div class="modal-overlay" id="logModal">
  <div class="modal">
    <div class="modal-title">üìñ Log Today's Reading</div>
    <div class="form-group">
      <label>Log by</label>
      <select id="logBySelect" onchange="updateLogForm()">
        <option value="juz">Juz (Para)</option>
        <option value="surah">Surah</option>
      </select>
    </div>
    <div id="juzLogForm">
      <div class="form-group">
        <label>Select Juz</label>
        <select id="logJuzSelect" onchange="updateSegments()"></select>
      </div>
      <div class="form-group">
        <label>Mark what you read</label>
        <div id="segmentChecks"></div>
      </div>
    </div>
    <div id="surahLogForm" style="display:none;">
      <div class="form-group">
        <label>Select Surah</label>
        <select id="logSurahSelect" onchange="updateAyahRange()"></select>
      </div>
      <div class="grid2" id="ayahRangeGroup">
        <div class="form-group">
          <label>From Ayah</label>
          <input type="number" id="fromAyah" min="1" value="1" />
        </div>
        <div class="form-group">
          <label>To Ayah</label>
          <input type="number" id="toAyah" min="1" value="7" />
        </div>
      </div>
      <div id="surahProgress" class="progress-wrap"></div>
    </div>
    <div class="form-group">
      <label>Note (optional)</label>
      <input id="logNote" placeholder="e.g. Morning after Fajr‚Ä¶" />
    </div>
    <div style="display:flex;gap:10px;margin-top:8px;">
      <button class="btn btn-gold" style="flex:1;" onclick="submitLog()">‚úì Save Reading</button>
      <button class="btn btn-outline" onclick="closeModal('logModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-icon">üïå</div>
    <div>
      <div class="logo-text">Quran Tracker</div>
      <div class="logo-sub">Daily Progress</div>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn btn-outline" onclick="openModal('logModal')">+ Log Reading</button>
    <div class="user-pill" onclick="openModal('userModal')">
      <div class="avatar" id="headerAvatar" style="background:#d4a843;color:#000;"></div>
      <span id="headerName">Select User</span>
    </div>
  </div>
</header>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</div>
  <div class="tab" onclick="switchTab('log')">üìñ Log Reading</div>
  <div class="tab" onclick="switchTab('progress')">üó∫ My Progress</div>
  <div class="tab" onclick="switchTab('leaderboard')">üèÜ Leaderboard</div>
</div>

<!-- MAIN -->
<main>

  <!-- DASHBOARD PAGE -->
  <div id="page-dashboard" class="page active">
    <div class="section-title">Today's <span>Overview</span></div>
    <div class="grid3" id="statCards">
      <div class="stat-card gold">
        <div class="stat-label">Total Pages Read</div>
        <div class="stat-val" id="statTotal">0</div>
        <div class="stat-sub">All users combined</div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">My Pages Today</div>
        <div class="stat-val" id="statToday">0</div>
        <div class="stat-sub" id="statTodaySub">Not logged yet</div>
      </div>
      <div class="stat-card blue">
        <div class="stat-label">My Quran Complete</div>
        <div class="stat-val" id="statPct">0%</div>
        <div class="stat-sub" id="statAyahs">0 / 6236 ayahs</div>
      </div>
    </div>
    <div class="grid2" style="margin-top:20px;">
      <div class="card">
        <div class="card-title">Weekly Reading (Pages)</div>
        <div class="chart-wrap"><canvas id="weekChart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">Top Readers Today</div>
        <div id="topToday"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">My Quran Progress ‚Äî Juz Overview</div>
      <div id="juzProgressBars"></div>
    </div>
  </div>

  <!-- LOG PAGE -->
  <div id="page-log" class="page">
    <div class="section-title">üìñ <span>Log</span> Your Reading</div>
    <div class="grid2">
      <div>
        <div class="card">
          <div class="card-title">Quick Log</div>
          <div class="form-group">
            <label>Log by</label>
            <select id="quickLogBy" onchange="updateQuickForm()">
              <option value="juz">Juz (Para)</option>
              <option value="surah">Surah</option>
            </select>
          </div>
          <div id="quickJuzForm">
            <div class="form-group">
              <label>Select Juz</label>
              <select id="quickJuzSel" onchange="updateQuickSegments()"></select>
            </div>
            <div class="form-group">
              <label>Segments read</label>
              <div id="quickSegChecks"></div>
            </div>
          </div>
          <div id="quickSurahForm" style="display:none;">
            <div class="form-group">
              <label>Select Surah</label>
              <select id="quickSurahSel" onchange="updateQuickAyah()"></select>
            </div>
            <div class="grid2">
              <div class="form-group">
                <label>From Ayah</label>
                <input type="number" id="quickFrom" min="1" value="1" />
              </div>
              <div class="form-group">
                <label>To Ayah</label>
                <input type="number" id="quickTo" min="1" />
              </div>
            </div>
            <div id="quickSurahProg" class="progress-wrap"></div>
          </div>
          <div class="form-group">
            <label>Note (optional)</label>
            <input id="quickNote" placeholder="e.g. After Fajr salah‚Ä¶" />
          </div>
          <button class="btn btn-gold" style="width:100%;" onclick="submitQuickLog()">‚úì Save Reading</button>
        </div>
      </div>
      <div>
        <div class="card">
          <div class="card-title">Recent Logs</div>
          <div id="recentLogs"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PROGRESS PAGE -->
  <div id="page-progress" class="page">
    <div class="section-title">üó∫ My <span>Progress Map</span></div>
    <div class="card">
      <div class="card-title">Juz Completion</div>
      <div class="juz-grid" id="juzGrid"></div>
    </div>
    <div class="card">
      <div class="card-title">Surah Reading Progress</div>
      <div id="surahProgressList"></div>
    </div>
  </div>

  <!-- LEADERBOARD PAGE -->
  <div id="page-leaderboard" class="page">
    <div class="section-title">üèÜ <span>Leaderboard</span></div>
    <div class="grid2">
      <div class="card">
        <div class="card-title">All-Time Pages Read</div>
        <div id="lbAllTime"></div>
      </div>
      <div class="card">
        <div class="card-title">This Week</div>
        <div id="lbWeek"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Group Progress Chart</div>
      <div class="chart-wrap"><canvas id="groupChart"></canvas></div>
    </div>
  </div>

  <!-- SETTINGS PAGE -->
  <div id="page-settings" class="page">
    <div class="section-title" style="margin-bottom:20px;">‚öôÔ∏è Settings</div>

    <!-- Fajr Reminder -->
    <div class="card" style="margin-bottom:14px;padding:20px;">
      <div style="font-size:11px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:14px;">üåÖ Fajr Reminder</div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <div>
          <div style="font-size:14px;font-weight:600;">Daily Fajr Reminder</div>
          <div style="font-size:12px;color:var(--muted);">Get notified to log your reading</div>
        </div>
        <label style="position:relative;width:44px;height:24px;flex-shrink:0;">
          <input type="checkbox" id="reminderToggle" onchange="toggleReminder()" style="opacity:0;width:0;height:0;"/>
          <span id="reminderSlider" style="position:absolute;inset:0;background:var(--surface3);border-radius:99px;cursor:pointer;transition:.3s;border:1px solid var(--border);"></span>
        </label>
      </div>
      <div id="reminderTimeWrap" style="display:none;">
        <label style="display:block;font-size:11px;color:var(--muted);margin-bottom:5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;">Reminder Time</label>
        <input type="time" id="reminderTime" value="05:30" onchange="saveReminderTime()" style="width:100%;background:var(--surface3);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px 12px;font-size:14px;font-family:inherit;outline:none;"/>
        <div style="font-size:12px;color:var(--muted);margin-top:8px;">You'll get a notification at this time if you haven't logged yet that day.</div>
      </div>
    </div>

    <!-- Sync Status -->
    <div class="card" style="margin-bottom:14px;padding:20px;">
      <div style="font-size:11px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:14px;">‚òÅÔ∏è Firebase Sync</div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <div id="syncDot2" style="width:10px;height:10px;border-radius:50%;background:#666;flex-shrink:0;"></div>
        <div style="font-size:14px;font-weight:600;">Live Sync Status</div>
      </div>
      <div style="font-size:13px;color:var(--muted);line-height:1.7;">When connected, all readings sync to Firebase so everyone's leaderboard updates in real time across devices.</div>
    </div>

    <!-- About -->
    <div class="card" style="padding:20px;">
      <div style="font-size:11px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:14px;">‚ÑπÔ∏è About</div>
      <div style="font-size:13px;color:var(--muted);line-height:1.9;">
        Version 2.0 ¬∑ Firebase + Local Sync<br/>
        114 Surahs ¬∑ 30 Juz ¬∑ 6,236 Ayahs<br/>
        Data saved locally + synced to cloud
      </div>
    </div>
  </div>

</main>

<script>
// ==============================
// QURAN DATA
// ==============================
const SURAHS = [
  {n:1,name:"Al-Fatiha",arabic:"ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©",ayahs:7,juz:1,page:1},
  {n:2,name:"Al-Baqarah",arabic:"ÿßŸÑÿ®ŸÇÿ±ÿ©",ayahs:286,juz:1,page:2},
  {n:3,name:"Al-Imran",arabic:"ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ",ayahs:200,juz:3,page:50},
  {n:4,name:"An-Nisa",arabic:"ÿßŸÑŸÜÿ≥ÿßÿ°",ayahs:176,juz:4,page:77},
  {n:5,name:"Al-Maidah",arabic:"ÿßŸÑŸÖÿßÿ¶ÿØÿ©",ayahs:120,juz:6,page:106},
  {n:6,name:"Al-Anam",arabic:"ÿßŸÑÿ£ŸÜÿπÿßŸÖ",ayahs:165,juz:7,page:128},
  {n:7,name:"Al-Araf",arabic:"ÿßŸÑÿ£ÿπÿ±ÿßŸÅ",ayahs:206,juz:8,page:151},
  {n:8,name:"Al-Anfal",arabic:"ÿßŸÑÿ£ŸÜŸÅÿßŸÑ",ayahs:75,juz:9,page:177},
  {n:9,name:"At-Tawbah",arabic:"ÿßŸÑÿ™Ÿàÿ®ÿ©",ayahs:129,juz:10,page:187},
  {n:10,name:"Yunus",arabic:"ŸäŸàŸÜÿ≥",ayahs:109,juz:11,page:208},
  {n:11,name:"Hud",arabic:"ŸáŸàÿØ",ayahs:123,juz:11,page:221},
  {n:12,name:"Yusuf",arabic:"ŸäŸàÿ≥ŸÅ",ayahs:111,juz:12,page:235},
  {n:13,name:"Ar-Rad",arabic:"ÿßŸÑÿ±ÿπÿØ",ayahs:43,juz:13,page:249},
  {n:14,name:"Ibrahim",arabic:"ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ",ayahs:52,juz:13,page:255},
  {n:15,name:"Al-Hijr",arabic:"ÿßŸÑÿ≠ÿ¨ÿ±",ayahs:99,juz:14,page:262},
  {n:16,name:"An-Nahl",arabic:"ÿßŸÑŸÜÿ≠ŸÑ",ayahs:128,juz:14,page:267},
  {n:17,name:"Al-Isra",arabic:"ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°",ayahs:111,juz:15,page:282},
  {n:18,name:"Al-Kahf",arabic:"ÿßŸÑŸÉŸáŸÅ",ayahs:110,juz:15,page:293},
  {n:19,name:"Maryam",arabic:"ŸÖÿ±ŸäŸÖ",ayahs:98,juz:16,page:305},
  {n:20,name:"Ta-Ha",arabic:"ÿ∑Ÿá",ayahs:135,juz:16,page:312},
  {n:21,name:"Al-Anbiya",arabic:"ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°",ayahs:112,juz:17,page:322},
  {n:22,name:"Al-Hajj",arabic:"ÿßŸÑÿ≠ÿ¨",ayahs:78,juz:17,page:332},
  {n:23,name:"Al-Muminun",arabic:"ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ",ayahs:118,juz:18,page:342},
  {n:24,name:"An-Nur",arabic:"ÿßŸÑŸÜŸàÿ±",ayahs:64,juz:18,page:350},
  {n:25,name:"Al-Furqan",arabic:"ÿßŸÑŸÅÿ±ŸÇÿßŸÜ",ayahs:77,juz:18,page:359},
  {n:26,name:"Ash-Shuara",arabic:"ÿßŸÑÿ¥ÿπÿ±ÿßÿ°",ayahs:227,juz:19,page:367},
  {n:27,name:"An-Naml",arabic:"ÿßŸÑŸÜŸÖŸÑ",ayahs:93,juz:19,page:377},
  {n:28,name:"Al-Qasas",arabic:"ÿßŸÑŸÇÿµÿµ",ayahs:88,juz:20,page:385},
  {n:29,name:"Al-Ankabut",arabic:"ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™",ayahs:69,juz:20,page:396},
  {n:30,name:"Ar-Rum",arabic:"ÿßŸÑÿ±ŸàŸÖ",ayahs:60,juz:21,page:404},
  {n:31,name:"Luqman",arabic:"ŸÑŸÇŸÖÿßŸÜ",ayahs:34,juz:21,page:411},
  {n:32,name:"As-Sajdah",arabic:"ÿßŸÑÿ≥ÿ¨ÿØÿ©",ayahs:30,juz:21,page:415},
  {n:33,name:"Al-Ahzab",arabic:"ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®",ayahs:73,juz:21,page:418},
  {n:34,name:"Saba",arabic:"ÿ≥ÿ®ÿ£",ayahs:54,juz:22,page:428},
  {n:35,name:"Fatir",arabic:"ŸÅÿßÿ∑ÿ±",ayahs:45,juz:22,page:434},
  {n:36,name:"Ya-Sin",arabic:"Ÿäÿ≥",ayahs:83,juz:22,page:440},
  {n:37,name:"As-Saffat",arabic:"ÿßŸÑÿµÿßŸÅÿßÿ™",ayahs:182,juz:23,page:446},
  {n:38,name:"Sad",arabic:"ÿµ",ayahs:88,juz:23,page:453},
  {n:39,name:"Az-Zumar",arabic:"ÿßŸÑÿ≤ŸÖÿ±",ayahs:75,juz:23,page:458},
  {n:40,name:"Ghafir",arabic:"ÿ∫ÿßŸÅÿ±",ayahs:85,juz:24,page:467},
  {n:41,name:"Fussilat",arabic:"ŸÅÿµŸÑÿ™",ayahs:54,juz:24,page:477},
  {n:42,name:"Ash-Shura",arabic:"ÿßŸÑÿ¥Ÿàÿ±Ÿâ",ayahs:53,juz:25,page:483},
  {n:43,name:"Az-Zukhruf",arabic:"ÿßŸÑÿ≤ÿÆÿ±ŸÅ",ayahs:89,juz:25,page:489},
  {n:44,name:"Ad-Dukhan",arabic:"ÿßŸÑÿØÿÆÿßŸÜ",ayahs:59,juz:25,page:496},
  {n:45,name:"Al-Jathiyah",arabic:"ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©",ayahs:37,juz:25,page:499},
  {n:46,name:"Al-Ahqaf",arabic:"ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ",ayahs:35,juz:26,page:502},
  {n:47,name:"Muhammad",arabic:"ŸÖÿ≠ŸÖÿØ",ayahs:38,juz:26,page:507},
  {n:48,name:"Al-Fath",arabic:"ÿßŸÑŸÅÿ™ÿ≠",ayahs:29,juz:26,page:511},
  {n:49,name:"Al-Hujurat",arabic:"ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™",ayahs:18,juz:26,page:515},
  {n:50,name:"Qaf",arabic:"ŸÇ",ayahs:45,juz:26,page:518},
  {n:51,name:"Adh-Dhariyat",arabic:"ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™",ayahs:60,juz:26,page:520},
  {n:52,name:"At-Tur",arabic:"ÿßŸÑÿ∑Ÿàÿ±",ayahs:49,juz:27,page:523},
  {n:53,name:"An-Najm",arabic:"ÿßŸÑŸÜÿ¨ŸÖ",ayahs:62,juz:27,page:526},
  {n:54,name:"Al-Qamar",arabic:"ÿßŸÑŸÇŸÖÿ±",ayahs:55,juz:27,page:528},
  {n:55,name:"Ar-Rahman",arabic:"ÿßŸÑÿ±ÿ≠ŸÖŸÜ",ayahs:78,juz:27,page:531},
  {n:56,name:"Al-Waqiah",arabic:"ÿßŸÑŸàÿßŸÇÿπÿ©",ayahs:96,juz:27,page:534},
  {n:57,name:"Al-Hadid",arabic:"ÿßŸÑÿ≠ÿØŸäÿØ",ayahs:29,juz:27,page:537},
  {n:58,name:"Al-Mujadila",arabic:"ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©",ayahs:22,juz:28,page:542},
  {n:59,name:"Al-Hashr",arabic:"ÿßŸÑÿ≠ÿ¥ÿ±",ayahs:24,juz:28,page:545},
  {n:60,name:"Al-Mumtahanah",arabic:"ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©",ayahs:13,juz:28,page:549},
  {n:61,name:"As-Saf",arabic:"ÿßŸÑÿµŸÅ",ayahs:14,juz:28,page:551},
  {n:62,name:"Al-Jumuah",arabic:"ÿßŸÑÿ¨ŸÖÿπÿ©",ayahs:11,juz:28,page:553},
  {n:63,name:"Al-Munafiqun",arabic:"ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ",ayahs:11,juz:28,page:554},
  {n:64,name:"At-Taghabun",arabic:"ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ",ayahs:18,juz:28,page:556},
  {n:65,name:"At-Talaq",arabic:"ÿßŸÑÿ∑ŸÑÿßŸÇ",ayahs:12,juz:28,page:558},
  {n:66,name:"At-Tahrim",arabic:"ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ",ayahs:12,juz:28,page:560},
  {n:67,name:"Al-Mulk",arabic:"ÿßŸÑŸÖŸÑŸÉ",ayahs:30,juz:29,page:562},
  {n:68,name:"Al-Qalam",arabic:"ÿßŸÑŸÇŸÑŸÖ",ayahs:52,juz:29,page:564},
  {n:69,name:"Al-Haqqah",arabic:"ÿßŸÑÿ≠ÿßŸÇÿ©",ayahs:52,juz:29,page:566},
  {n:70,name:"Al-Maarij",arabic:"ÿßŸÑŸÖÿπÿßÿ±ÿ¨",ayahs:44,juz:29,page:568},
  {n:71,name:"Nuh",arabic:"ŸÜŸàÿ≠",ayahs:28,juz:29,page:570},
  {n:72,name:"Al-Jinn",arabic:"ÿßŸÑÿ¨ŸÜ",ayahs:28,juz:29,page:572},
  {n:73,name:"Al-Muzzammil",arabic:"ÿßŸÑŸÖÿ≤ŸÖŸÑ",ayahs:20,juz:29,page:574},
  {n:74,name:"Al-Muddaththir",arabic:"ÿßŸÑŸÖÿØÿ´ÿ±",ayahs:56,juz:29,page:575},
  {n:75,name:"Al-Qiyamah",arabic:"ÿßŸÑŸÇŸäÿßŸÖÿ©",ayahs:40,juz:29,page:577},
  {n:76,name:"Al-Insan",arabic:"ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ",ayahs:31,juz:29,page:578},
  {n:77,name:"Al-Mursalat",arabic:"ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™",ayahs:50,juz:29,page:580},
  {n:78,name:"An-Naba",arabic:"ÿßŸÑŸÜÿ®ÿ£",ayahs:40,juz:30,page:582},
  {n:79,name:"An-Naziat",arabic:"ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™",ayahs:46,juz:30,page:583},
  {n:80,name:"Abasa",arabic:"ÿπÿ®ÿ≥",ayahs:42,juz:30,page:585},
  {n:81,name:"At-Takwir",arabic:"ÿßŸÑÿ™ŸÉŸàŸäÿ±",ayahs:29,juz:30,page:586},
  {n:82,name:"Al-Infitar",arabic:"ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±",ayahs:19,juz:30,page:587},
  {n:83,name:"Al-Mutaffifin",arabic:"ÿßŸÑŸÖÿ∑ŸÅŸÅŸäŸÜ",ayahs:36,juz:30,page:587},
  {n:84,name:"Al-Inshiqaq",arabic:"ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ",ayahs:25,juz:30,page:589},
  {n:85,name:"Al-Buruj",arabic:"ÿßŸÑÿ®ÿ±Ÿàÿ¨",ayahs:22,juz:30,page:590},
  {n:86,name:"At-Tariq",arabic:"ÿßŸÑÿ∑ÿßÿ±ŸÇ",ayahs:17,juz:30,page:591},
  {n:87,name:"Al-Ala",arabic:"ÿßŸÑÿ£ÿπŸÑŸâ",ayahs:19,juz:30,page:591},
  {n:88,name:"Al-Ghashiyah",arabic:"ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©",ayahs:26,juz:30,page:592},
  {n:89,name:"Al-Fajr",arabic:"ÿßŸÑŸÅÿ¨ÿ±",ayahs:30,juz:30,page:593},
  {n:90,name:"Al-Balad",arabic:"ÿßŸÑÿ®ŸÑÿØ",ayahs:20,juz:30,page:594},
  {n:91,name:"Ash-Shams",arabic:"ÿßŸÑÿ¥ŸÖÿ≥",ayahs:15,juz:30,page:595},
  {n:92,name:"Al-Layl",arabic:"ÿßŸÑŸÑŸäŸÑ",ayahs:21,juz:30,page:595},
  {n:93,name:"Ad-Duha",arabic:"ÿßŸÑÿ∂ÿ≠Ÿâ",ayahs:11,juz:30,page:596},
  {n:94,name:"Ash-Sharh",arabic:"ÿßŸÑÿ¥ÿ±ÿ≠",ayahs:8,juz:30,page:596},
  {n:95,name:"At-Tin",arabic:"ÿßŸÑÿ™ŸäŸÜ",ayahs:8,juz:30,page:597},
  {n:96,name:"Al-Alaq",arabic:"ÿßŸÑÿπŸÑŸÇ",ayahs:19,juz:30,page:597},
  {n:97,name:"Al-Qadr",arabic:"ÿßŸÑŸÇÿØÿ±",ayahs:5,juz:30,page:598},
  {n:98,name:"Al-Bayyinah",arabic:"ÿßŸÑÿ®ŸäŸÜÿ©",ayahs:8,juz:30,page:598},
  {n:99,name:"Az-Zalzalah",arabic:"ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©",ayahs:8,juz:30,page:599},
  {n:100,name:"Al-Adiyat",arabic:"ÿßŸÑÿπÿßÿØŸäÿßÿ™",ayahs:11,juz:30,page:599},
  {n:101,name:"Al-Qariah",arabic:"ÿßŸÑŸÇÿßÿ±ÿπÿ©",ayahs:11,juz:30,page:600},
  {n:102,name:"At-Takathur",arabic:"ÿßŸÑÿ™ŸÉÿßÿ´ÿ±",ayahs:8,juz:30,page:600},
  {n:103,name:"Al-Asr",arabic:"ÿßŸÑÿπÿµÿ±",ayahs:3,juz:30,page:601},
  {n:104,name:"Al-Humazah",arabic:"ÿßŸÑŸáŸÖÿ≤ÿ©",ayahs:9,juz:30,page:601},
  {n:105,name:"Al-Fil",arabic:"ÿßŸÑŸÅŸäŸÑ",ayahs:5,juz:30,page:601},
  {n:106,name:"Quraysh",arabic:"ŸÇÿ±Ÿäÿ¥",ayahs:4,juz:30,page:602},
  {n:107,name:"Al-Maun",arabic:"ÿßŸÑŸÖÿßÿπŸàŸÜ",ayahs:7,juz:30,page:602},
  {n:108,name:"Al-Kawthar",arabic:"ÿßŸÑŸÉŸàÿ´ÿ±",ayahs:3,juz:30,page:602},
  {n:109,name:"Al-Kafirun",arabic:"ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ",ayahs:6,juz:30,page:603},
  {n:110,name:"An-Nasr",arabic:"ÿßŸÑŸÜÿµÿ±",ayahs:3,juz:30,page:603},
  {n:111,name:"Al-Masad",arabic:"ÿßŸÑŸÖÿ≥ÿØ",ayahs:5,juz:30,page:603},
  {n:112,name:"Al-Ikhlas",arabic:"ÿßŸÑÿ•ÿÆŸÑÿßÿµ",ayahs:4,juz:30,page:604},
  {n:113,name:"Al-Falaq",arabic:"ÿßŸÑŸÅŸÑŸÇ",ayahs:5,juz:30,page:604},
  {n:114,name:"An-Nas",arabic:"ÿßŸÑŸÜÿßÿ≥",ayahs:6,juz:30,page:604}
];

// Juz segments: each Juz has Hizb halves (Nisf), quarters (Rubu) etc.
// Simplified: 4 quarters per Juz = Rub'ul Hizb
const JUZ_DATA = Array.from({length:30}, (_,i) => {
  const n = i+1;
  return {
    n,
    name: `Juz ${n}`,
    arabic: `ÿßŸÑÿ¨ÿ≤ÿ° ${n}`,
    segments: [
      {id:`${n}_1`, label:`1st Quarter (1/4)`, arabic:"ÿßŸÑÿ±ÿ®ÿπ ÿßŸÑÿ£ŸàŸÑ", pages:5},
      {id:`${n}_2`, label:`2nd Quarter (1/2)`, arabic:"ÿßŸÑŸÜÿµŸÅ", pages:5},
      {id:`${n}_3`, label:`3rd Quarter (3/4)`, arabic:"ÿßŸÑÿ±ÿ®ÿπ ÿßŸÑÿ´ÿßŸÑÿ´", pages:5},
      {id:`${n}_4`, label:`4th Quarter (Full)`, arabic:"ÿßŸÑÿ±ÿ®ÿπ ÿßŸÑÿ±ÿßÿ®ÿπ", pages:5},
    ]
  };
});

const TOTAL_AYAHS = 6236;
const TOTAL_PAGES = 604;
const PAGES_PER_JUZ = 20;

// AVATAR COLORS
const COLORS = ['#d4a843','#3fb950','#388bfd','#f78166','#db61a2','#79c0ff','#56d364','#ffa657'];
const avatarColor = (name) => COLORS[name.charCodeAt(0) % COLORS.length];
const initials = (name) => name.slice(0,2).toUpperCase();

// ==============================
// STATE (localStorage)
// ==============================
const LS_KEY = 'quranTracker_v2';
let state = {
  users: [],
  currentUser: null,
  logs: [] // {id, user, type:'juz'|'surah', juzN, segments:[], surahN, fromAyah, toAyah, note, date, pages}
};

function loadState() {
  try {
    const saved = localStorage.getItem(LS_KEY);
    if (saved) state = JSON.parse(saved);
  } catch(e) {}
}
function saveState() {
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
// Firebase: push a single new log entry (called after state.logs.push)
async function fbPushLog(l) {
  if (!window._fbOK) return;
  try {
    const {db,collection,addDoc} = window._fb;
    await addDoc(collection(db,'logs'), {...l, _dev: location.hostname});
  } catch(e) { console.warn('FB push failed:', e.message); }
}
// Firebase: sync all logs from all users into local state (one-time pull on load)
function fbStartSync() {
  if (!window._fbOK) return;
  const {db,collection,query,orderBy,onSnapshot} = window._fb;
  const q = query(collection(db,'logs'), orderBy('date','desc'));
  onSnapshot(q, snap => {
    const remote = snap.docs.map(d => ({...d.data(), _fbId: d.id}));
    // Merge remote logs into state: add any not already present by id
    let changed = false;
    remote.forEach(r => {
      const exists = state.logs.some(l => l.id === r.id);
      if (!exists && r.id) { state.logs.push(r); changed = true; }
    });
    if (changed) { saveState(); renderAll(); updateHeader(); renderUserModal(); }
    // Show sync dot green
    const dot = document.getElementById('syncDot');
    if (dot) dot.style.background = '#3fb950';
  }, err => {
    console.warn('FB sync error:', err.message);
    const dot = document.getElementById('syncDot');
    if (dot) dot.style.background = '#e74c3c';
  });
}


function getMyLogs(user) {
  return state.logs.filter(l => l.user === (user || state.currentUser));
}
function getTodayLogs(user) {
  const today = todayStr();
  return state.logs.filter(l => l.user === (user || state.currentUser) && l.date === today);
}
function todayStr() {
  return new Date().toISOString().split('T')[0];
}
function weeksAgo(n=6) {
  const d = new Date(); d.setDate(d.getDate() - n*7);
  return d.toISOString().split('T')[0];
}

// ==============================
// USER MANAGEMENT
// ==============================
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function renderUserModal() {
  const ul = document.getElementById('userList');
  const chips = document.getElementById('userChips');
  if (!state.users.length) {
    ul.innerHTML = '<div style="color:var(--muted);font-size:13px;margin-bottom:10px;">No users yet. Add one below!</div>';
    chips.innerHTML = '';
    return;
  }
  ul.innerHTML = state.users.map(u => `
    <div class="lb-row" style="cursor:pointer;" onclick="selectUser('${u}')">
      <div class="lb-avatar" style="background:${avatarColor(u)};color:#000;">${initials(u)}</div>
      <div class="lb-info"><div class="lb-name">${u}</div><div class="lb-detail">${getMyLogs(u).length} logs total</div></div>
      ${state.currentUser===u ? '<span class="badge">Active</span>' : ''}
    </div>
  `).join('');
  chips.innerHTML = state.users.map(u => `
    <div class="chip">
      <div class="lb-avatar" style="background:${avatarColor(u)};color:#000;width:18px;height:18px;font-size:9px;">${initials(u)}</div>
      ${u}
      <span class="chip-del" onclick="removeUser('${u}')">√ó</span>
    </div>
  `).join('');
}

function addUser() {
  const inp = document.getElementById('newUserInput');
  const name = inp.value.trim();
  if (!name) return;
  if (state.users.includes(name)) { showNotify('Name already exists'); return; }
  state.users.push(name);
  if (!state.currentUser) selectUser(name);
  saveState();
  inp.value = '';
  renderUserModal();
}

function removeUser(name) {
  if (!confirm(`Remove ${name}?`)) return;
  state.users = state.users.filter(u => u !== name);
  if (state.currentUser === name) state.currentUser = state.users[0] || null;
  saveState();
  renderUserModal();
  updateHeader();
  renderAll();
}

function selectUser(name) {
  state.currentUser = name;
  saveState();
  closeModal('userModal');
  updateHeader();
  renderAll();
  showNotify(`Welcome back, ${name}! üåô`);
}

function updateHeader() {
  const av = document.getElementById('headerAvatar');
  const nm = document.getElementById('headerName');
  if (state.currentUser) {
    av.style.background = avatarColor(state.currentUser);
    av.style.color = '#000';
    av.textContent = initials(state.currentUser);
    nm.textContent = state.currentUser;
  } else {
    av.textContent = '?'; av.style.background = '#666';
    nm.textContent = 'Select User';
  }
}

// ==============================
// NOTIFICATIONS
// ==============================
function showNotify(msg) {
  const n = document.getElementById('notify');
  n.textContent = msg;
  n.style.display = 'block';
  setTimeout(() => n.style.display = 'none', 2500);
}

// ==============================
// TABS
// ==============================
function switchTab(id) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    const ids = ['dashboard','log','progress','leaderboard','settings'];
    t.classList.toggle('active', ids[i] === id);
  });
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if (id === 'leaderboard') renderLeaderboard();
  if (id === 'progress') renderProgressPage();
  if (id === 'log') renderRecentLogs();
}

// ==============================
// POPULATE SELECTS
// ==============================
function populateSelects() {
  ['logJuzSelect','quickJuzSel'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = JUZ_DATA.map(j => `<option value="${j.n}">${j.n}. ${j.name}</option>`).join('');
  });
  ['logSurahSelect','quickSurahSel'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = SURAHS.map(s => `<option value="${s.n}">${s.n}. ${s.name} (${s.arabic}) ‚Äî ${s.ayahs} ayahs</option>`).join('');
  });
}

// ==============================
// SEGMENT CHECKBOXES
// ==============================
function getSegChecks(juzN, containerId) {
  const juz = JUZ_DATA[juzN-1];
  const readSegs = getReadSegments(state.currentUser);
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = juz.segments.map(s => `
    <div class="seg-row" onclick="toggleSeg('${s.id}','${containerId}')">
      <input type="checkbox" id="seg_${s.id}" ${readSegs.has(s.id)?'checked':''} onclick="event.stopPropagation();"/>
      <div class="seg-info">
        <div class="seg-name">${s.label}</div>
        <div class="seg-sub arabic" style="font-size:13px;">${s.arabic} ¬∑ ~${s.pages} pages</div>
      </div>
    </div>
  `).join('');
}

function toggleSeg(id, containerId) {
  const cb = document.getElementById('seg_'+id);
  if (cb) cb.checked = !cb.checked;
}

function updateSegments() {
  const n = parseInt(document.getElementById('logJuzSelect').value);
  getSegChecks(n, 'segmentChecks');
}
function updateQuickSegments() {
  const n = parseInt(document.getElementById('quickJuzSel').value);
  getSegChecks(n, 'quickSegChecks');
}

// ==============================
// AYAH RANGE
// ==============================
function updateAyahRange() {
  const n = parseInt(document.getElementById('logSurahSelect').value);
  const s = SURAHS[n-1];
  document.getElementById('toAyah').max = s.ayahs;
  document.getElementById('fromAyah').max = s.ayahs;
  document.getElementById('toAyah').value = s.ayahs;
  document.getElementById('fromAyah').value = getNextAyah(n);
  updateSurahProgress('surahProgress', n);
}
function updateQuickAyah() {
  const n = parseInt(document.getElementById('quickSurahSel').value);
  const s = SURAHS[n-1];
  document.getElementById('quickTo').max = s.ayahs;
  document.getElementById('quickTo').value = s.ayahs;
  document.getElementById('quickFrom').max = s.ayahs;
  document.getElementById('quickFrom').value = getNextAyahQuick(n);
  updateSurahProgress('quickSurahProg', n);
}

function getNextAyah(surahN) {
  const logs = getMyLogs().filter(l => l.type==='surah' && l.surahN===surahN);
  if (!logs.length) return 1;
  const maxRead = Math.max(...logs.map(l=>l.toAyah));
  const next = Math.min(maxRead + 1, SURAHS[surahN-1].ayahs);
  // Show hint
  const hintEl = document.getElementById('surahContinueHint');
  if (hintEl) hintEl.innerHTML = `<div style="background:rgba(212,168,67,.1);border:1px solid rgba(212,168,67,.3);border-radius:8px;padding:8px 12px;font-size:12px;margin-bottom:10px;">üìå Last read: Ayah <strong>${maxRead}</strong> ‚Äî continuing from <strong>${next}</strong></div>`;
  return next;
}
function getNextAyahQuick(surahN) {
  const logs = getMyLogs().filter(l => l.type==='surah' && l.surahN===surahN);
  if (!logs.length) return 1;
  const maxRead = Math.max(...logs.map(l=>l.toAyah));
  const next = Math.min(maxRead + 1, SURAHS[surahN-1].ayahs);
  const hintEl = document.getElementById('quickSurahHint');
  if (hintEl) hintEl.innerHTML = `<div style="background:rgba(212,168,67,.1);border:1px solid rgba(212,168,67,.3);border-radius:8px;padding:8px 12px;font-size:12px;margin-bottom:10px;">üìå Last read: Ayah <strong>${maxRead}</strong> ‚Äî continuing from <strong>${next}</strong></div>`;
  return next;
}

function updateSurahProgress(containerId, surahN) {
  const s = SURAHS[surahN-1];
  const logs = getMyLogs().filter(l => l.type==='surah' && l.surahN===surahN);
  const read = logs.length ? Math.max(...logs.map(l=>l.toAyah)) : 0;
  const pct = Math.round(read/s.ayahs*100);
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = `
    <div class="progress-wrap">
      <div class="progress-label"><span>${s.name} progress</span><span>${read}/${s.ayahs} ayahs (${pct}%)</span></div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
    </div>`;
}

// ==============================
// LOG FORM TOGGLE
// ==============================
function updateLogForm() {
  const v = document.getElementById('logBySelect').value;
  document.getElementById('juzLogForm').style.display = v==='juz'?'':'none';
  document.getElementById('surahLogForm').style.display = v==='surah'?'':'none';
  if(v==='juz') updateSegments();
  if(v==='surah') updateAyahRange();
}
function updateQuickForm() {
  const v = document.getElementById('quickLogBy').value;
  document.getElementById('quickJuzForm').style.display = v==='juz'?'':'none';
  document.getElementById('quickSurahForm').style.display = v==='surah'?'':'none';
  if(v==='juz') updateQuickSegments();
  if(v==='surah') updateQuickAyah();
}

// ==============================
// SUBMIT LOG
// ==============================
function buildLogFromModal(prefix='') {
  if (!state.currentUser) { showNotify('Please select a user first!'); return null; }
  const by = prefix ? document.getElementById(prefix+'LogBy').value : document.getElementById('logBySelect').value;
  let log = {
    id: Date.now()+'_'+Math.random(),
    user: state.currentUser,
    type: by,
    date: todayStr(),
    note: document.getElementById(prefix ? prefix+'Note' : 'logNote').value.trim()
  };
  if (by === 'juz') {
    const juzN = parseInt(document.getElementById(prefix ? prefix+'JuzSel' : 'logJuzSelect').value);
    const containerId = prefix ? prefix+'SegChecks' : 'segmentChecks';
    const checked = [...document.querySelectorAll(`#${containerId} input[type=checkbox]:checked`)].map(c => c.id.replace('seg_',''));
    if (!checked.length) { showNotify('Please select at least one segment!'); return null; }
    log.juzN = juzN;
    log.segments = checked;
    log.pages = checked.length * 5;
    log.ayahs = checked.length * 50; // approx
  } else {
    const surahN = parseInt(document.getElementById(prefix ? prefix+'SurahSel' : 'logSurahSelect').value);
    const from = parseInt(document.getElementById(prefix ? prefix+'From' : 'fromAyah').value);
    const to = parseInt(document.getElementById(prefix ? prefix+'To' : 'toAyah').value);
    if (from > to) { showNotify('From ayah must be ‚â§ To ayah'); return null; }
    log.surahN = surahN;
    log.fromAyah = from;
    log.toAyah = to;
    log.ayahs = to - from + 1;
    log.pages = Math.ceil(log.ayahs / 10);
  }
  return log;
}

function submitLog() {
  const log = buildLogFromModal('log');
  if (!log) return;
  // For modal prefix detection - rebuild from correct IDs
  if (!state.currentUser) { showNotify('Please select a user first!'); return; }
  const by = document.getElementById('logBySelect').value;
  let l = {id: Date.now()+'_'+Math.random(), user: state.currentUser, type: by, date: todayStr(), note: document.getElementById('logNote').value.trim()};
  if (by==='juz') {
    const juzN = parseInt(document.getElementById('logJuzSelect').value);
    const checked = [...document.querySelectorAll('#segmentChecks input[type=checkbox]:checked')].map(c => c.id.replace('seg_',''));
    if (!checked.length) { showNotify('Select at least one segment!'); return; }
    l.juzN=juzN; l.segments=checked; l.pages=checked.length*5; l.ayahs=checked.length*50;
  } else {
    const surahN = parseInt(document.getElementById('logSurahSelect').value);
    const from = parseInt(document.getElementById('fromAyah').value);
    const to = parseInt(document.getElementById('toAyah').value);
    if (from>to) { showNotify('From ‚â§ To required'); return; }
    l.surahN=surahN; l.fromAyah=from; l.toAyah=to; l.ayahs=to-from+1; l.pages=Math.ceil(l.ayahs/10);
  }
  state.logs.push(l);
  saveState();
  fbPushLog(l);
  closeModal('logModal');
  showNotify('‚úÖ Reading logged! Jazakallah khayran üåô');
  renderAll();
}

function submitQuickLog() {
  if (!state.currentUser) { showNotify('Please select a user first!'); openModal('userModal'); return; }
  const by = document.getElementById('quickLogBy').value;
  let l = {id: Date.now()+'_'+Math.random(), user: state.currentUser, type: by, date: todayStr(), note: document.getElementById('quickNote').value.trim()};
  if (by==='juz') {
    const juzN = parseInt(document.getElementById('quickJuzSel').value);
    const checked = [...document.querySelectorAll('#quickSegChecks input[type=checkbox]:checked')].map(c => c.id.replace('seg_',''));
    if (!checked.length) { showNotify('Select at least one segment!'); return; }
    l.juzN=juzN; l.segments=checked; l.pages=checked.length*5; l.ayahs=checked.length*50;
  } else {
    const surahN = parseInt(document.getElementById('quickSurahSel').value);
    const from = parseInt(document.getElementById('quickFrom').value);
    const to = parseInt(document.getElementById('quickTo').value);
    if (from>to) { showNotify('From ‚â§ To required'); return; }
    l.surahN=surahN; l.fromAyah=from; l.toAyah=to; l.ayahs=to-from+1; l.pages=Math.ceil(l.ayahs/10);
  }
  state.logs.push(l);
  saveState();
  fbPushLog(l);
  document.getElementById('quickNote').value = '';
  showNotify('‚úÖ Reading logged! üåô');
  renderAll();
}

// ==============================
// STATS
// ==============================
function getUserStats(user) {
  const logs = getMyLogs(user);
  const todayL = logs.filter(l=>l.date===todayStr());
  const allAyahs = logs.filter(l=>l.type==='surah').reduce((a,l)=>a+l.ayahs,0)
    + logs.filter(l=>l.type==='juz').reduce((a,l)=>a+l.ayahs,0);
  const allPages = logs.reduce((a,l)=>a+(l.pages||0),0);
  const todayPages = todayL.reduce((a,l)=>a+(l.pages||0),0);
  return { logs, todayPages, allPages, allAyahs };
}

function getReadSegments(user) {
  const set = new Set();
  getMyLogs(user).filter(l=>l.type==='juz').forEach(l => (l.segments||[]).forEach(s=>set.add(s)));
  return set;
}

// ==============================
// DASHBOARD RENDER
// ==============================
let weekChartInst = null;
function renderDashboard() {
  // Stats
  const me = state.currentUser;
  const allLogs = state.logs;
  const total = allLogs.reduce((a,l)=>a+(l.pages||0),0);
  document.getElementById('statTotal').textContent = total;
  if (me) {
    const s = getUserStats(me);
    document.getElementById('statToday').textContent = s.todayPages;
    document.getElementById('statTodaySub').textContent = s.todayPages>0 ? `${getTodayLogs().length} logs today` : 'Not logged yet';
    const pct = Math.min(100, Math.round(s.allAyahs/TOTAL_AYAHS*100));
    document.getElementById('statPct').textContent = pct+'%';
    document.getElementById('statAyahs').textContent = `${s.allAyahs.toLocaleString()} / ${TOTAL_AYAHS.toLocaleString()} ayahs`;
  }

  // Top today
  const topDiv = document.getElementById('topToday');
  const today = todayStr();
  const todayByUser = {};
  state.logs.filter(l=>l.date===today).forEach(l => {
    todayByUser[l.user] = (todayByUser[l.user]||0) + (l.pages||0);
  });
  const sorted = Object.entries(todayByUser).sort((a,b)=>b[1]-a[1]);
  if (!sorted.length) {
    topDiv.innerHTML = '<div class="empty"><div class="empty-icon">üìñ</div><div class="empty-text">No readings logged today yet.</div></div>';
  } else {
    topDiv.innerHTML = sorted.slice(0,5).map(([u,p],i) => `
      <div class="lb-row">
        <div class="lb-rank ${['gold','silver','bronze'][i]||''}">${i+1}</div>
        <div class="lb-avatar" style="background:${avatarColor(u)};color:#000;">${initials(u)}</div>
        <div class="lb-info"><div class="lb-name">${u}</div><div class="lb-detail">${p} pages today</div></div>
        <div class="lb-pages">${p}</div>
      </div>`).join('');
  }

  // Weekly chart
  const labels = [];
  const data = [];
  for (let i=6;i>=0;i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    const ds = d.toISOString().split('T')[0];
    labels.push(['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]);
    const dayPages = me ? state.logs.filter(l=>l.user===me&&l.date===ds).reduce((a,l)=>a+(l.pages||0),0) : 0;
    data.push(dayPages);
  }
  const ctx = document.getElementById('weekChart').getContext('2d');
  if (weekChartInst) weekChartInst.destroy();
  weekChartInst = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Pages',
        data,
        backgroundColor: data.map((_,i) => i===6 ? '#d4a843' : 'rgba(212,168,67,0.3)'),
        borderRadius: 6,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } },
        y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' }, beginAtZero: true }
      }
    }
  });

  // Juz progress bars
  const juzBars = document.getElementById('juzProgressBars');
  if (!me) { juzBars.innerHTML = '<div class="empty"><div class="empty-text">Select a user to see progress.</div></div>'; return; }
  const readSegs = getReadSegments(me);
  const juzHtml = JUZ_DATA.map(j => {
    const done = j.segments.filter(s=>readSegs.has(s.id)).length;
    const pct = Math.round(done/4*100);
    if (pct===0) return '';
    return `
      <div class="progress-wrap" style="margin-bottom:10px;">
        <div class="progress-label"><span>Juz ${j.n}</span><span>${pct}%</span></div>
        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      </div>`;
  }).filter(Boolean).join('') || '<div style="color:var(--muted);font-size:13px;">Start logging Juz readings to see progress here.</div>';
  juzBars.innerHTML = juzHtml;
}

// ==============================
// PROGRESS PAGE
// ==============================
function renderProgressPage() {
  const me = state.currentUser;
  const juzGrid = document.getElementById('juzGrid');
  const surahList = document.getElementById('surahProgressList');
  if (!me) {
    juzGrid.innerHTML = '<div class="empty"><div class="empty-text">Select a user first.</div></div>';
    surahList.innerHTML = '';
    return;
  }
  const readSegs = getReadSegments(me);
  juzGrid.innerHTML = JUZ_DATA.map(j => {
    const done = j.segments.filter(s=>readSegs.has(s.id)).length;
    const pct = Math.round(done/4*100);
    return `
      <div class="juz-cell ${pct===100?'read':''}" title="${done}/4 quarters read">
        <div class="juz-num">${j.n}</div>
        <div class="juz-label">${pct}%</div>
      </div>`;
  }).join('');

  // Surah progress
  const surahLogs = getMyLogs(me).filter(l=>l.type==='surah');
  const surahRead = {};
  surahLogs.forEach(l => {
    if (!surahRead[l.surahN] || surahRead[l.surahN] < l.toAyah) surahRead[l.surahN] = l.toAyah;
  });
  const withLogs = SURAHS.filter(s=>surahRead[s.n]);
  if (!withLogs.length) {
    surahList.innerHTML = '<div class="empty"><div class="empty-icon">üìö</div><div class="empty-text">No surah readings logged yet.</div></div>';
    return;
  }
  surahList.innerHTML = withLogs.map(s => {
    const read = surahRead[s.n] || 0;
    const pct = Math.round(read/s.ayahs*100);
    return `
      <div class="progress-wrap" style="margin-bottom:14px;">
        <div class="progress-label">
          <span><strong>${s.n}. ${s.name}</strong> <span class="arabic">${s.arabic}</span></span>
          <span class="badge ${pct===100?'green':''}">${read}/${s.ayahs} ayahs ¬∑ ${pct}%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%;${pct===100?'background:var(--green);':''}"></div></div>
      </div>`;
  }).join('');
}

// ==============================
// RECENT LOGS
// ==============================
function renderRecentLogs() {
  const div = document.getElementById('recentLogs');
  const logs = state.logs.slice().reverse().slice(0,20);
  if (!logs.length) {
    div.innerHTML = '<div class="empty"><div class="empty-icon">üìñ</div><div class="empty-text">No readings logged yet.</div></div>';
    return;
  }
  div.innerHTML = logs.map(l => {
    let desc = '';
    if (l.type==='juz') {
      desc = `Juz ${l.juzN} ‚Äî ${(l.segments||[]).length} quarters read (~${l.pages} pages)`;
    } else {
      const s = SURAHS[l.surahN-1];
      desc = `${s?.name||'?'} ‚Äî Ayah ${l.fromAyah}‚Äì${l.toAyah} (${l.ayahs} ayahs)`;
    }
    return `
      <div class="log-item">
        <div class="lb-avatar" style="background:${avatarColor(l.user)};color:#000;width:30px;height:30px;font-size:11px;flex-shrink:0;">${initials(l.user)}</div>
        <div>
          <div class="log-text"><strong>${l.user}</strong> ‚Äî ${desc}</div>
          <div class="log-meta">${l.date}${l.note ? ' ¬∑ '+l.note : ''}</div>
        </div>
      </div>`;
  }).join('');
}

// ==============================
// LEADERBOARD
// ==============================
let groupChartInst = null;
function renderLeaderboard() {
  function buildLb(containerId, filterFn) {
    const byUser = {};
    state.logs.filter(filterFn).forEach(l => {
      byUser[l.user] = (byUser[l.user]||0) + (l.pages||0);
    });
    const sorted = Object.entries(byUser).sort((a,b)=>b[1]-a[1]);
    const el = document.getElementById(containerId);
    if (!sorted.length) { el.innerHTML = '<div class="empty"><div class="empty-text">No data yet.</div></div>'; return; }
    el.innerHTML = sorted.map(([u,p],i) => `
      <div class="lb-row">
        <div class="lb-rank ${['gold','silver','bronze'][i]||''}">${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':i+1}</div>
        <div class="lb-avatar" style="background:${avatarColor(u)};color:#000;">${initials(u)}</div>
        <div class="lb-info"><div class="lb-name">${u}</div><div class="lb-detail">${state.logs.filter(l=>l.user===u&&filterFn(l)).length} entries</div></div>
        <div class="lb-pages">${p}</div>
      </div>`).join('');
  }
  const weekStart = (() => { const d=new Date(); d.setDate(d.getDate()-7); return d.toISOString().split('T')[0]; })();
  buildLb('lbAllTime', ()=>true);
  buildLb('lbWeek', l=>l.date>=weekStart);

  // Group chart - last 7 days per user
  const labels = [];
  for (let i=6;i>=0;i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    labels.push(['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]);
  }
  const datasets = state.users.map(u => {
    const data = [];
    for (let i=6;i>=0;i--) {
      const d = new Date(); d.setDate(d.getDate()-i);
      const ds = d.toISOString().split('T')[0];
      data.push(state.logs.filter(l=>l.user===u&&l.date===ds).reduce((a,l)=>a+(l.pages||0),0));
    }
    return { label: u, data, borderColor: avatarColor(u), backgroundColor: avatarColor(u)+'33', borderWidth: 2, tension: 0.4, fill: false, pointRadius: 4 };
  });
  const ctx = document.getElementById('groupChart').getContext('2d');
  if (groupChartInst) groupChartInst.destroy();
  groupChartInst = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#8b949e', boxWidth: 12 } } },
      scales: {
        x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } },
        y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' }, beginAtZero: true }
      }
    }
  });
}

// ==============================
// RENDER ALL
// ==============================
function renderAll() {
  renderDashboard();
  renderRecentLogs();
}

// ==============================
// INIT
// ==============================
document.addEventListener('DOMContentLoaded', () => {
  loadState();
  populateSelects();
  updateHeader();
  updateSegments();
  updateAyahRange();
  updateQuickSegments();
  updateQuickAyah();
  renderUserModal();
  renderAll();

  // Open user modal if no user selected
  if (!state.currentUser) {
    setTimeout(() => openModal('userModal'), 300);
  }

  // Close modals on overlay click
  document.querySelectorAll('.modal-overlay').forEach(el => {
    el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
  });

  // Enter key for new user
  document.getElementById('newUserInput').addEventListener('keydown', e => {
    if (e.key==='Enter') addUser();
  });

  document.getElementById('logJuzSelect').addEventListener('change', updateSegments);
  document.getElementById('logSurahSelect').addEventListener('change', updateAyahRange);

  // Start Firebase sync (wait until module loaded)
  function tryFbSync() {
    if (window._fbOK) { fbStartSync(); }
    else { setTimeout(tryFbSync, 200); }
  }
  tryFbSync();

  // Fajr reminder
  loadReminderSettings();
});
</script>

<script>

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRIMARY / SECONDARY READING TYPE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Logs now have optional rtype: 'primary' | 'secondary'
// primary = competes on leaderboard, counts toward completion
// secondary = personal extra reading, separate section

function getMyPrimaryLogs(user) {
  return getMyLogs(user).filter(l => !l.rtype || l.rtype === 'primary');
}
function getMySecondaryLogs(user) {
  return getMyLogs(user).filter(l => l.rtype === 'secondary');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAJR REMINDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadReminderSettings() {
  const s = JSON.parse(localStorage.getItem('qt_reminder') || '{}');
  const tog = document.getElementById('reminderToggle');
  const tw  = document.getElementById('reminderTimeWrap');
  const tm  = document.getElementById('reminderTime');
  if (!tog) return;
  if (s.on) {
    tog.checked = true;
    if (tw) tw.style.display = '';
    if (tm && s.time) tm.value = s.time;
    scheduleReminder();
  }
}
function toggleReminder() {
  const on = document.getElementById('reminderToggle').checked;
  const tw = document.getElementById('reminderTimeWrap');
  if (tw) tw.style.display = on ? '' : 'none';
  if (on) { requestNotifPermission(); scheduleReminder(); }
  else { localStorage.removeItem('qt_reminder'); showNotify('Reminder turned off'); }
}
async function requestNotifPermission() {
  if (!('Notification' in window)) { showNotify('Notifications not supported on this browser'); return; }
  const p = await Notification.requestPermission();
  if (p !== 'granted') { showNotify('Please allow notifications to use reminders'); document.getElementById('reminderToggle').checked = false; return; }
  showNotify('Notifications enabled ‚úÖ');
}
function saveReminderTime() {
  scheduleReminder();
  showNotify('Reminder time saved!');
}
function scheduleReminder() {
  const time = document.getElementById('reminderTime')?.value || '05:30';
  localStorage.setItem('qt_reminder', JSON.stringify({on:true, time}));
  clearInterval(window._remInt);
  window._remInt = setInterval(() => {
    const s = JSON.parse(localStorage.getItem('qt_reminder') || '{}');
    if (!s.on) return;
    const now = new Date();
    const [h,m] = s.time.split(':').map(Number);
    if (now.getHours() === h && now.getMinutes() === m) {
      const me = state.currentUser;
      const logged = me && state.logs.some(l => l.user === me && l.date === todayStr());
      if (!logged && Notification.permission === 'granted') {
        new Notification('üåÖ Quran Tracker ‚Äî Fajr Reminder', {
          body: `Assalamualaikum ${me||''}! Don't forget to log your Quran reading today. üìñ`,
          icon: 'icon-192.png'
        });
      }
    }
  }, 60000);
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
